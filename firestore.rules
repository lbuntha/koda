rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get the user's profile document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check specific roles
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }

    function isAdmin() {
      return hasRole('ADMIN');
    }

    function isTeacher() {
      return hasRole('TEACHER');
    }

    function isStudent() {
      return hasRole('STUDENT');
    }

    function isParent() {
      return hasRole('PARENT');
    }

    // Check if the user is a parent of the target student
    function isParentOf(studentId) {
      return isParent() && studentId in getUserData().children;
    }

    // --- Collection Rules ---

    // USERS Collection
    match /users/{userId} {
      // Read: All authenticated users can read user profiles
      // This is needed for features like leaderboards, class rosters, etc.
      allow read: if isAuthenticated();

      // Create:
      // Allow users to sign up. 
      // Validation: Must match auth UID, cannot create 'ADMIN' role directly.
      allow create: if isAuthenticated() && 
                    request.auth.uid == userId && 
                    request.resource.data.role != 'ADMIN';

      // Update:
      // 1. Own profile (but safeguard critical fields like 'role', 'subscriptionTier'?)
      //    For this iteration, trusting client to not change role, OR we safeguard 'role'.
      //    Safeguard: Request role must equal existing role OR be Admin.
      // 2. Admin can update anyone.
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId && request.resource.data.role == resource.data.role) || 
        isAdmin()
      );

      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // SKILLS Collection (Educational Content)
    match /skills/{skillId} {
      // Read: All authenticated users (Students need to take quizzes, Teachers manage)
      allow read: if isAuthenticated();

      // Write: Admin and Teachers only
      allow write: if isAdmin() || isTeacher();
    }

    // RESULTS Collection (Student Quiz/Game Results)
    match /results/{resultId} {
      // Read:
      // 1. The student who owns the result
      // 2. Admin / Teacher
      // 3. Parent of the student
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        isAdmin() ||
        isTeacher() ||
        isParentOf(resource.data.studentId)
      );

      // Write:
      // 1. Student creating their own result
      // 2. Admin / Teacher
      allow write: if isAuthenticated() && (
        (request.resource.data.studentId == request.auth.uid) ||
        isAdmin() ||
        isTeacher()
      );
    }

    // REWARDS Collection (Gamification)
    match /rewards/{rewardId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    // BADGES Collection (Achievements)
    match /badges/{badgeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isTeacher();
    }

    // GOALS Collection
    match /goals/{goalId} {
      // Read: All authenticated users can read goals
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        request.resource.data.studentId == request.auth.uid ||
        isAdmin() ||
        isTeacher()
      );
    }

    // SETTINGS / MENU Collections (System Config)
    match /settings/{settingId} {
      allow read: if isAuthenticated(); // Global settings often needed by app
      allow write: if isAdmin();
    }
    
    match /menuItems/{itemId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    match /menuPermissions/{permId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // TOKEN LOGS (Usage Tracking)
    match /token_logs/{logId} {
      // Read: Admin only (Students shouldn't see everyone's logs)
      allow read: if isAdmin();

      // Write: 
      // Users log their own usage.
      // Validate: userId in log matches auth uid.
      allow create: if isAuthenticated() && 
                    request.resource.data.userId == request.auth.uid;
      
      // Updates/Deletes: Admin only (logs should be immutable usually)
      allow update, delete: if isAdmin();
    }

    // COMPONENT DEFINITIONS (Custom Question Types)
    match /component_definitions/{defId} {
      // Read: All authenticated users need to load components to assume quizzes
      allow read: if isAuthenticated();

      // Write: Admin and Teachers only
      allow write: if isAdmin() || isTeacher();
    }
  }
}
